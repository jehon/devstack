---

- name: Guess os for jehon-os package
  when: jehon_os_package is undefined or jehon_os_package | length == 0
  block:
    - name: Check that /usr/bin/lsb_release exists
      stat:
        path: /usr/bin/lsb_release
      register: usr_bin_lsb_release_exists

    - name: With lsb_release
      when: not usr_bin_lsb_release_exists.stat.exists
      block:
        - name: Ensure lsb_module is installed
          ansible.builtin.apt:
            state: present
            pkg:
              - lsb-release
          register: jh_init_lsb_release_installed

        - name: Recalculate ansible_lsb
          # ansible_lsb depend on lsb-release to be installed
          when: jh_init_lsb_release_installed.changed
          ansible.builtin.setup:
            filter:
              # What to recalculate ?
              - ansible_lsb

    - name: Calculate os name from ansible_lsb.id
      when: ansible_lsb.id is defined and ansible_lsb.id | length > 0
      ansible.builtin.set_fact:
        jehon_os_package: "jehon-os-{{ ansible_lsb.id | lower }}"

- name: Fallback jehon_os_package
  ansible.builtin.set_fact:
    jehon_os_package: ""

- name: What is jehon_os_package?
  debug:
    var: jehon_os_package

- name: Detect if it is a full machine or not
  when: jh_is_full_machine is undefined
  block:
    - name: Check that jh-is-full-machine exists
      stat:
        path: /usr/bin/jh-is-full-machine
      register: jh_is_full_machine_exists

    - name: Is full machine
      when: jh_is_full_machine_exists.stat.exists
      block:
        - name: Detect full machine
          ansible.builtin.command:
            cmd: /usr/bin/jh-is-full-machine -q systemd
          register: jh_is_full_machine_exec
          failed_when: jh_is_full_machine_exec.rc > 1
          changed_when: false

        - name: Register
          ansible.builtin.set_fact:
            jh_is_full_machine: "{{ jh_is_full_machine_exec.rc == 0 }}"

- name: Fallback jh_is_full_machine
  ansible.builtin.set_fact:
    jh_is_full_machine: False

- name: Is full machine?
  debug:
    var: jh_is_full_machine
